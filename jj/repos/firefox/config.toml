#:schema https://jj-vcs.github.io/jj/latest/config-schema.json

# NOTE: This configuration was generated from Erich's scripting at
# <https://github.com/erichdongubler-mozilla/fx-scripts>. If you need to edit it,
# consider sharing upstream!

fsmonitor.backend = "watchman"
# fsmonitor.watchman.register-snapshot-trigger = true

[aliases]
"trains" = ["log", "--revisions=show_fork_point(trains() | @)"]

[revset-aliases]
"trunk()" = "main@upstream"

# NOTE: Typical `builtin_immutable_heads()` is `trunk() | tags() | untracked_remote_branches()`, but
# I want to exclude tags of the form `pin/*`. It's weird, I know, but it's what I want!
"immutable_heads()" = '''
trunk() | tags(regex:"^[^p][^i][^n][^/]") | untracked_remote_bookmarks()
| remote_bookmarks(exact:'autoland')
| trains()
'''

"trains()" = '''
trunk()
| remote_bookmarks(exact:'beta')
| remote_bookmarks(regex:'^esr\d+$')
| remote_bookmarks(exact:'release')
'''

[git]
fetch = ["origin", "upstream"]

[fix.tools.clang-format]
command = [
  "~/.mozbuild/clang-tools/clang-tidy/bin/clang-format",
  "--assume-filename=$path",
]
patterns = ["glob:'**/*.c'", "glob:'**/*.h'", "glob:'**/*.cpp'"]

[remotes.origin]
auto-track-bookmarks = "*"

[template-aliases]
"erichdongubler_preferred()" = """
if(
  root,
  format_root_commit(self),
  label(if(current_working_copy, "working_copy"),
    concat(
      separate(" ",
        label("erichdongubler_dash_fluff", "---"),
        format_short_change_id_with_change_offset(self),
        format_short_commit_id(commit_id),
        label("erichdongubler_dash_fluff", "-"),
        bookmarks,
        tags,
        working_copies,
        if(self.contained_in("first_parent(@)"), label("git_head", "HEAD")),
        if(conflict, label("conflict", "conflict")),
      ),
      "\n",
      separate(" ",
        if(empty, label("empty", "(empty)")),
        if(
          description,
          if(
            description
              .first_line()
              .match(regex:'^Bug \\d+\\b'),
            separate(
              "",
              hyperlink(
                separate(
                  "",
                  "https://bugzilla.mozilla.org/show_bug.cgi?id=",
                  description
                    .first_line()
                    .replace(
                      regex:'^Bug (\\d+)\\b.*$',
                      "$1",
                    ),
                ),
                description
                  .first_line()
                  .replace(
                    regex:'^(Bug \\d+)\\b.*$',
                    "$1",
                  ),
              ),
              description
                .first_line()
                .replace(
                  regex:'^Bug \\d+\\b(.*)$',
                  "$1",
                ),
            ),
            description.first_line(),
          ),
          description_placeholder,
        ),
        label("author", if(author.name(), author.name(), email_placeholder)),
        format_timestamp(committer.timestamp()),
      ),
    ),
  ),
)
"""
